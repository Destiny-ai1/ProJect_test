<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="/style/main.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="/script/inputFunction.js"></script>
<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<title>주문 상세 및 결제 페이지</title>
</head>
<body>
    <div id="app">
        <header th:replace="~{/fragment/header.html}"> </header>
        <nav th:replace="~{/fragment/nav.html}"></nav>
        <main>
            <section class="container mt-5">
                <h1 class="mb-4">주문 상세 및 결제 페이지</h1>

                <!-- 주문 정보가 없는 경우 표시하는 메시지 -->
                <div th:if="${orders == null || #lists.isEmpty(orders)}">
                    <p>주문 정보가 없습니다.</p>
                </div>

                <!-- 주문 목록이 있는 경우 테이블로 출력 -->
				<div th:if="${orders != null && !#lists.isEmpty(orders)}" class="card mb-3">
				    <div class="card-header">주문 정보</div>
				    <div class="card-body">
				        <table class="table table-bordered">
						    <thead>
						        <tr>
						        	<th>선택</th>
						            <th>주문 번호</th>
						            <th>총 가격</th>
						            <th>사용할 포인트</th>
						            <th>실제 결제 금액</th>
						        </tr>
						    </thead>
						    <tbody>
						        <tr th:each="order : ${orders}">
						        	<td>
						                <input type="radio" name="selectedOrder" th:value="${order.orderNo}" onclick="onSelectOrder(this.value)" />
						            </td>
						            <td th:text="${order.orderNo}"></td>
						            <td th:text="${order.totalPrice}"></td>
						            <td th:text="${order.usedPoint}"></td>
						            <td th:text="${order.actPayment}"></td>						            
						        </tr>
						    </tbody>
						</table>
				    </div>
				
				    <!-- 주문 상세 항목 -->
				    <div th:each="order : ${orders}">
				        <div th:if="${order?.orderDetails != null && !#lists.isEmpty(order.orderDetails)}" class="card mb-3">
				            <div class="card-header">주문 상세 항목</div>
				            <div class="card-body">
				                <table class="table table-bordered">
				                    <thead>
				                        <tr>
				                            <th>상품 번호</th>
				                            <th>이미지</th>
				                            <th>상품 이름</th>
				                            <th>수량</th>
				                            <th>가격</th>
				                        </tr>
				                    </thead>
				                    <tbody>
				                        <tr th:each="detail : ${order.orderDetails}">
				                            <td th:text="${detail?.itemNo != null ? detail.itemNo : 'N/A'}"></td>
				                            <td><img th:src="${detail?.image != null ? detail.image : '/images/default.png'}" alt="상품 이미지" style="width: 100px;"></td>
				                            <td th:text="${detail?.itemName != null ? detail.itemName : 'N/A'}"></td>
				                            <td th:text="${detail?.detailEa != null ? detail.detailEa : 0}"></td>
				                            <td th:text="${detail?.price != null ? detail.price : 0}"></td>
				                        </tr>
				                    </tbody>
				                </table>
				            </div>
				        </div>
				    </div>
				    
				    <!-- 배송지 정보 -->
					<div class="card mb-3">
						<div class="card-header">배송지 정보</div>
						<div class="card-body">
							<p><strong>우편 번호:</strong> <input type="text" id="postNo" readonly /></p>
							<p><strong>기본 주소:</strong> <input type="text" id="addressMain" readonly /></p>
							<p><strong>도로명 주소:</strong> <input type="text" id="addressRoad" readonly /></p>
							<p><strong>상세 주소:</strong> <input type="text" id="addressDetail" /></p>
							<p><strong>주소 이름:</strong> <input type="text" id="addressName" /></p>
							<button type="button" class="btn btn-primary mt-3" onclick="execDaumPostcode()">주소 검색</button>
						</div>
					</div>
					<p>Order 정보: <span th:text="${order}">N/A</span></p>
				
				    <!-- 결제 정보 입력 및 카카오페이 결제 -->
				    <div class="card mb-3">
				        <div class="card-header">결제 정보 입력 및 카카오페이 결제</div>
				        <div class="card-body">
				            <form action="/payment/ready" method="post">
							    <input type="hidden" name="_csrf" th:value="${_csrf.token}" />
							    <input type="hidden" id="orderNo" name="orderNo" value="" />
								<input type="hidden" id="username" name="username" value="" />
								<input type="hidden" id="itemName" name="itemName" value="" />
								<input type="hidden" id="totalAmount" name="totalAmount" value="" />
							    <button type="submit" class="btn btn-warning">카카오페이로 결제하기</button>
							</form>
				        </div>
				    </div>
				</div>
            </section>
        </main>
        <footer th:replace="~{/fragment/footer.html}"> </footer>
    </div>

	

    <script>
    function execDaumPostcode() {
        new daum.Postcode({
            oncomplete: function(data) {
                // 기존 코드: 검색 결과 항목을 클릭했을 때 실행할 코드

                // 우편번호를 postNo에 할당
                document.getElementById('postNo').value = data.zonecode;

                // 기본 주소 (지번 주소 혹은 도로명 주소)
                if (data.roadAddress) {
                    document.getElementById('addressMain').value = data.roadAddress;
                    document.getElementById('addressRoad').value = data.roadAddress; // 도로명 주소 할당
                } else {
                    document.getElementById('addressMain').value = data.jibunAddress;
                    document.getElementById('addressRoad').value = ''; // 도로명 주소가 없을 때 빈 값
                }

                // 상세 주소는 사용자가 직접 입력하도록 남겨둠

                // 추가된 코드: 상세 주소가 비어 있는 경우 사용자에게 안내 메시지
                if (!document.getElementById('addressDetail').value) {
                    alert('상세 주소를 입력해 주세요.');
                }
            },
            onerror: function(error) {
                console.error('Error during postcode search:', error);
            }
        }).open();
    }

    </script>

	<script>
    // 주문 선택 후, 선택된 주문의 정보를 각 필드에 설정합니다.
    function setOrderDetails(order) {
        document.getElementById('orderNo').value = order.orderNo;
        document.getElementById('username').value = order.memberUsername;
        document.getElementById('itemName').value = order.orderDetails[0].itemName;
        document.getElementById('totalAmount').value = order.actPayment;
    }

    // 사용자가 특정 주문을 선택했을 때 실행
    function onSelectOrder(orderNo) {
        let selectedOrder = getOrderInfoByOrderNo(orderNo);
        setOrderDetails(selectedOrder);
    }

    // 예시 데이터를 반환하는 함수 (실제로는 서버에서 가져오는 방식으로 변경)
    function getOrderInfoByOrderNo(orderNo) {
        return {
            orderNo: orderNo,
            memberUsername: "guest1",
            orderDetails: [{ itemName: "iPhone 16 Pro" }],
            actPayment: 1550000
        };
    }
    
	document.querySelector("form[action='/payment/ready']").addEventListener("submit", function (event) {
	    let orderNo = document.querySelector('input[name="orderNo"]').value;
	    let postNo = document.getElementById('postNo').value;
	    let addressMain = document.getElementById('addressMain').value;
	    let addressDetail = document.getElementById('addressDetail').value;

	    // 주문 번호가 없을 때
	    if (!orderNo || orderNo === 'N/A') {
	        event.preventDefault();
	        alert("주문 번호가 설정되지 않았습니다. 주문을 다시 확인해 주세요.");
	        return;
	    }

	    // 배송지 정보가 입력되지 않았을 때
	    if (!postNo || !addressMain || !addressDetail) {
	        event.preventDefault();
	        alert("배송지 정보를 모두 입력해 주세요.");
	        return;
	    }
	});


	</script>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        let orderNo = document.getElementById('orderNo').value;/* 주문 번호를 설정하는 로직 추가 (e.g., 템플릿 엔진을 사용하여 값 삽입) */
        
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'hidden') {
                // 페이지를 떠날 때 주문 취소 요청을 보냄
                fetch('/order/auto-cancel', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ orderId: orderNo })
                }).then(response => {
                    if (!response.ok) {
                        console.error('Failed to cancel order:', response.statusText);
                    }
                }).catch(error => {
                    console.error('Error:', error);
                });
            }
        });
    });
    </script>
</body>
</html>
