<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/style/main.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            document.querySelector('.checkout-button').addEventListener('click', function(event) {
                let selectedItems = document.querySelectorAll('input[name="selectedItems"]:checked');
                if (selectedItems.length === 0) {
                    alert('최소 하나의 상품을 선택해야 합니다.');
                    event.preventDefault(); // 폼 제출 중단
                    return;
                }

                // 선택된 항목들을 hidden input으로 orderForm에 추가
                let form = document.getElementById('orderForm');
                selectedItems.forEach(item => {
                    let input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'selectedItems';
                    input.value = item.value;
                    form.appendChild(input);
                });
            });
        });
    </script>
    <title>장바구니</title>
</head>
<body>
    <div id="app">
        <!-- 공통 헤더 영역 불러오기 -->
        <header th:replace="~{/fragment/header.html}"> </header>
        <!-- 공통 네비게이션 영역 불러오기 -->
        <nav th:replace="~{/fragment/nav.html}"></nav>
        <main>
            <section class="cart-container">
                <h1>장바구니</h1>
                <!-- 장바구니가 비어 있을 때 메시지 표시 -->
                <div th:if="${emptyMessage != null}">
                    <p th:text="${emptyMessage}"></p> <!-- '장바구니가 비어 있습니다.' 메시지를 출력 -->
                </div>

                <!-- 장바구니 항목이 있을 때 목록 표시 -->
                <form th:action="@{/order/list}" method="post" id="orderForm">
                    <input type="hidden" name="${_csrf.parameterName}" th:value="${_csrf.token}" /> <!-- CSRF 토큰 추가 -->
                    <table class="table table-bordered table-hover">
                        <thead class="thead-light">
                            <tr>
                                <th>선택</th>
                                <th>이미지</th>
                                <th>상품명</th>
                                <th>수량</th>
                                <th>개별 가격</th>
                                <th>합계</th>
                                <th>수정/삭제</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="item : ${result}">
                                <td>
                                    <input type="checkbox" name="selectedItems" th:value="${item.itemNo}" /> <!-- 선택 체크박스 -->
                                </td>
                                <td>
                                    <img th:src="${item.imageName}" alt="상품 이미지" class="img-thumbnail" style="width: 100px;"> <!-- 상품 이미지 출력 -->
                                </td>
                                <td>
                                    <h5 th:text="${item.itemIrum}">상품명</h5> <!-- 상품명 출력 -->
                                </td>
                                <td>
                                    <div class="item-quantity">
                                        <input type="number" th:id="'quantity-' + ${item.itemNo}" name="quantity" th:value="${item.cartEa}" min="1" class="form-control" /> <!-- 수량 입력 필드 -->
                                    </div>
                                </td>
                                <td>
                                    <p th:text="'₩ ' + ${item.cartPrice}">₩ 가격</p> <!-- 상품 개별 가격 출력 -->
                                </td>
                                <td>
                                    <p th:text="'₩ ' + ${item.cartTotalPrice}">₩ 합계</p> <!-- 상품 총 가격 출력 -->
                                </td>
                                <td>
                                    <!-- 장바구니 항목 수정 폼 -->
                                    <form th:action="@{/cart/update}" method="post" th:object="${item}" style="display:inline-block;">
                                        <input type="hidden" name="${_csrf.parameterName}" th:value="${_csrf.token}" /> <!-- CSRF 토큰 추가 -->
                                        <input type="hidden" name="itemNo" th:value="${item.itemNo}" /> <!-- 수정할 상품 번호 -->
                                        <input type="hidden" name="username" th:value="${item.username}" /> <!-- 사용자 이름 -->
                                        <input type="number" name="cartEa" th:value="${item.cartEa}" min="1" class="form-control mt-2 d-none" /> <!-- 수정할 수량 입력 (숨김 처리) -->
                                        <button type="submit" class="btn btn-warning">변경</button> <!-- 수정 버튼 -->
                                    </form>
                                    <!-- 장바구니 항목 삭제 폼 -->
                                    <form th:action="@{/cart/delete}" method="post" th:object="${item}" style="display:inline-block;">
                                        <input type="hidden" name="${_csrf.parameterName}" th:value="${_csrf.token}" /> <!-- CSRF 토큰 추가 -->
                                        <input type="hidden" name="itemNo" th:value="${item.itemNo}" /> <!-- 삭제할 상품 번호 -->
                                        <button type="submit" class="btn btn-danger">삭제</button> <!-- 삭제 버튼 -->
                                    </form>
                                </td>
                            </tr>
                        </tbody>
                    </table>

                    <!-- 장바구니 총합계 및 주문하기 버튼 -->
                    <div class="cart-summary text-end">
                        <h2>총 합계</h2>
                        <p class="total-price fw-bold" th:text="'₩ ' + ${totalPrice}">₩ 총합계</p> <!-- 장바구니 총 합계 출력 -->
                        <button type="submit" class="btn btn-primary checkout-button mt-2">주문하기</button> <!-- 주문하기 버튼 -->
                    </div>
                </form>
            </section>
        </main>
        <!-- 공통 푸터 영역 불러오기 -->
        <footer th:replace="~{/fragment/footer.html}"> </footer>
    </div>
</body>
</html>
