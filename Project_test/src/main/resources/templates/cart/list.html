<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet">
<script
    src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<title>장바구니</title>
</head>

<!-- CSRF Token -->
<meta name="_csrf" th:content="${_csrf.token}">
<meta name="_csrf_header" th:content="${_csrf.headerName}">
<script>
$(document).ready(function() {
	// CSRF 토큰 설정
    const csrfHeaderName = $('meta[name="_csrf_header"]').attr('content');
    const csrfToken = $('meta[name="_csrf"]').attr('content');

    $.ajaxSetup({
        beforeSend: function (xhr) {
            if (csrfHeaderName && csrfToken) {
                xhr.setRequestHeader(csrfHeaderName, csrfToken);
            }
        }
    });
    
 	// 금액 합계 업데이트 함수
    function updateTotalAmount() {
        let totalAmount = 0;
        $('.choice:checked').each(function () {
            const row = $(this).closest('tr');
            const price = parseInt(row.find('td:nth-child(4)').text().replace('원', ''), 10);
            const quantity = parseInt(row.find('.cartEaInput').val(), 10);
            totalAmount += price * quantity;
        });
        $('#totalAmount').text(`${totalAmount}원`);
    }
 	
 	// 전체 선택 체크박스 처리
    $('#select-all').change(function () {
        const isChecked = $(this).is(':checked');
        $('.choice').prop('checked', isChecked);
        updateTotalAmount();
    });
 
 	// 개별 체크박스 클릭 시 금액 합계 업데이트
    $(document).on('change', '.choice', function () {
        updateTotalAmount();
    });
	
    // 장바구니 출력 함수
    function printCart(result) {
        const $tbody = $('#tbody');
        const $table = $('#cartTable');  // 테이블 전체
        $tbody.empty();  // 기존 내용을 지우고 갱신된 장바구니 내용 추가

        // 장바구니 내용을 먼저 숨깁니다.
        $table.hide();

        // 결과에 따라 장바구니 내용 추가
        for (let item of result) {
            const tr = `
                <tr>
                    <td>
                        <!-- 체크박스에 itemNo와 itemSize 값을 전달 -->
                        <input type="checkbox" class="choice" data-item_no="${item.itemNo}" data-item_size="${item.itemSize}" name="itemNos" value="${item.itemNo}">
                    </td>
                    <td>
                        <!-- 이미지 경로를 API 방식으로 변경 -->
                        <img src="/api/images?imagename=${item.itemImage}" style="height: 100px;">
                    </td>
                    <td>
                        <!-- 상품명과 사이즈를 함께 표시 -->
                        <span>${item.itemIrum}</span>
                        <span ${item.itemSize ? '' : 'style="display:none;"'}> (${item.itemSize})</span> <!-- 사이즈 정보 표시 -->
                    </td>
                    <td>
                        ${item.itemPrice}원
                    </td>
                    <td>
                        <input type="number" class="cartEaInput" value="${item.cartEa}" data-itemNo="${item.itemNo}" data-itemSize="${item.itemSize}" min="1">
                        <button class="btn btn-primary update">수량 변경</button>
                    </td>
                    <td>
                        ${item.cartTotalPrice}원
                    </td>
                </tr>
            `;
            $(tr).appendTo($tbody);
        }

        // 모든 이미지가 로딩된 후에 테이블을 표시하도록 처리
        let images = $('.cart-image');
        let imageCount = images.length;
        let loadedImages = 0;

        images.each(function() {
            $(this).on('load', function() {
                loadedImages++;
                if (loadedImages === imageCount) {
                    // 모든 이미지가 로드되었을 때, 테이블을 다시 보이게 함
                    $table.fadeIn();
                }
            });
        });

        // 이미지가 미리 로드되었을 경우 바로 보여주기
        if (loadedImages === imageCount) {
            $table.fadeIn();
        }
    }

 	// 수량 변경 버튼 클릭 처리
    $(document).on('click', '.update', function() {
        const cartUpdates = [];  // 수정할 장바구니 데이터 배열 초기화

        const $inputs = $('.cartEaInput');
        $inputs.each(function() {
            const itemNo = $(this).attr('data-itemNo');  // data-itemNo로 itemNo 가져오기
            const itemSize = $(this).attr('data-itemSize');  // data-itemSize로 itemSize 가져오기
            const cartEa = Number($(this).val());  // 수량을 Number로 변환

            console.log("itemNo:", itemNo, "itemSize:", itemSize, "cartEa:", cartEa);  // 확인을 위한 로그 추가

            // 수량이 1 이상인지 체크
            if (isNaN(cartEa) || cartEa < 1) {
                alert("수량은 1 이상이어야 합니다.");
                return;
            }

            if (itemNo && !isNaN(Number(itemNo)) && itemSize) {  // itemNo와 itemSize가 모두 존재할 경우에만 처리
                cartUpdates.push({
                    itemNo: itemNo,  // itemNo 값은 그대로 문자열로 저장
                    itemSize: itemSize,  // itemSize도 포함
                    cartEa: cartEa
                });
            }
        });

        // cartUpdates 배열이 비어 있지 않다면 서버로 요청
        if (cartUpdates.length > 0) {
            console.log("Sending cart updates: ", cartUpdates);  // 서버로 보내는 데이터 로그

            $.ajax({
                url: '/api/cart/updateCart',  // 올바른 API 경로로 수정
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(cartUpdates),
                success: function(result) {
                    printCart(result);  // 장바구니 갱신
                    alert("수량이 변경되었습니다.");
                    location.reload();
                },
                error: function(xhr, status, error) {
                    console.error('Error:', error);
                    
                    if (xhr.status === 409) {
                        // 서버에서 보낸 재고 부족 메시지를 알림으로 표시
                        Swal.fire({
                            icon: 'error',
                            title: '재고 부족',
                            text: xhr.responseText,  // 서버에서 반환된 메시지 표시
                        }).then(() => {
                            // 알림이 닫힌 후 페이지를 새로고침
                            location.reload();
                        });
                    } else {
                        // 재고 초과 오류 시 alert 메시지 표시 후 새로고침
                        alert("구매하시려는 상품이 재고 수량을 초과합니다");
                        location.reload();  // alert 후 페이지 새로고침
                    }
                }
            });
        } else {
            console.error("업데이트할 장바구니 데이터가 없습니다.");
        }
    });
});
</script>

<script>
$(document).ready(function() {
    // 선택삭제 버튼 클릭 시 동작
    $('#deleteBtn').click(function(e) {
        e.preventDefault();  // 기본 동작 방지
        var selectedItems = [];

        // 선택된 체크박스를 가져옴
        $('input.choice:checked').each(function() {
            var itemNo = $(this).val().trim();  // 체크박스의 itemNo 값 가져옴
            var itemSize = $(this).attr('data-itemSize');  // data-itemSize로 itemSize 가져옴

            // itemNo와 itemSize가 모두 존재하는지 확인 후 배열에 추가
            if (itemNo && itemSize) {
                selectedItems.push({ itemNo: itemNo, itemSize: itemSize });  // itemNo와 itemSize를 객체로 저장
            }
        });

        if (selectedItems.length > 0) {
            // 사용자에게 삭제 확인 여부를 묻는 팝업 띄우기
            if (confirm("정말로 선택한 항목을 삭제하시겠습니까?")) {
                // 삭제 요청을 서버로 전송
                $.ajax({
                    url: '/cart/delete',  // 삭제 요청 URL
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(selectedItems),  // itemNo와 itemSize를 포함한 객체 배열을 전송
                    success: function(result) {
                        // 삭제 후 알림 메시지 띄우기
                        alert("선택한 항목이 삭제되었습니다.");

                        // 화면을 새로 고침하여 갱신된 데이터를 받아옴
                        location.reload();
                    },
                    error: function(xhr, status, error) {
                        console.error('Error:', error);
                        console.error('Response Text:', xhr.responseText);
                        alert("서버 오류: " + xhr.responseText);
                    }
                });
            }
        } else {
            // 선택된 항목이 없으면 경고
            alert('삭제할 항목을 선택해주세요.');
        }
    });
});
</script>

<body>
    <div id="app">
    	<!-- CSRF 토큰 메타 태그 -->
        <!-- <meta name="_csrf" content="${_csrf.token}" />  -->
    
        <header th:replace="~{/fragment/header.html}"></header>
        <nav th:replace="~{/fragment/nav.html}"></nav>
        <section>
            <div th:text="${result}"></div>
            <table class="table" id="cartTable">
                <thead>
                    <tr>
                        <th><input type="checkbox" id="select-all"> 선택</th>
                        <th>상품</th>
                        <th>상품명</th>
                        <th>금액</th>
                        <th>구매수량</th>
                        <th>총 금액</th>
                    </tr>
                </thead>
                <tbody id="tbody">
                    <!-- Thymeleaf에서 데이터 출력 -->
                    <tr th:each="item : ${result}">
                        <td><input type="checkbox" class="choice"
                            th:value="${item.itemNo}" th:data-itemNo="${item.itemNo}"
                            th:data-itemSize="${item.itemSize}" name="itemNos"></td>
                        <td><img th:src="${item.itemImage}" style="height: 100px;"></td>
                        <td th:utext="${item.itemIrum + (item.itemSize != null ? ' (' + item.itemSize + ')' : '')}"></td>
                        <td th:text="${item.itemPrice + '원'}"></td>
                        <td><input type="number" class="cartEaInput"
                            th:value="${item.cartEa}" th:data-itemNo="${item.itemNo}"
                            th:data-itemSize="${item.itemSize}" min="1">
                            <button class="btn btn-primary update">수량 변경</button></td>
                        <td th:text="${item.cartTotalPrice + '원'}"></td>
                    </tr>
                </tbody>
            </table>

            <!-- 버튼 배치 -->
            <div class="text-center mt-3">
				<h5>총 금액: <span id="totalAmount">0원</span></h5>
				<button class="btn btn-success" id="order">선택주문</button>
				<button type="button" id="deleteBtn" class="btn btn-danger">선택삭제</button>
			</div>
        </section>
        <footer th:replace="~{/fragment/footer.html}"></footer>
    </div>
</body>
</html>
