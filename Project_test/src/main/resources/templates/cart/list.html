<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
	rel="stylesheet">
<script
	src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<title>장바구니</title>
</head>
<script>
$(document).ready(function() {
    // 장바구니 출력 함수
    function printCart(result) {
        const $tbody = $('#tbody');
        $tbody.empty();
        for (let item of result) {
            // 콘솔 로그 추가: item.itemImage 값 확인
            console.log('Item Image URL:', item.itemImage);

            const tr = `
                <tr>
                    <td>
                        <input type="checkbox" class="choice" data-item_no="${item.itemNo}" name="itemNos" value="${item.itemNo}">
                    </td>
                    <td>
                        <img src="${item.itemImage}" style="height:100px;">
                    </td>
                    <td>
                        ${item.itemIrum} 
                    </td>
                    <td>
                        ${item.itemPrice}원
                    </td>
                    <td>
                        <input type="number" class="cartEaInput" value="${item.cartEa}" data-itemNo="${item.itemNo}" min="1">
                        <button class="btn btn-primary update">수량 변경</button> <!-- 수량 변경 버튼 유지 -->
                    </td>
                    <td>
                        ${item.cartTotalPrice}원
                    </td>
                </tr>
            `;
            $(tr).appendTo($tbody);
        }
    }

    // 수량 변경 버튼 클릭 처리
    $(document).on('click', '.update', function() {
        const cartUpdates = [];  // 수정할 장바구니 데이터 배열 초기화

        const $inputs = $('.cartEaInput');
        $inputs.each(function() {
            const itemNo = $(this).attr('data-itemNo');  // data-itemNo로 itemNo 가져오기
            const cartEa = Number($(this).val());  // 수량을 Number로 변환

            console.log('itemNo:', itemNo);  // itemNo 값 로그로 확인
            console.log('cartEa:', cartEa);  // cartEa 값 로그로 확인

            if (isNaN(cartEa) || cartEa < 1) {
                alert("수량은 1 이상이어야 합니다.");
                return;
            }

            if (itemNo && !isNaN(Number(itemNo))) {  // itemNo가 숫자인지 확인
                cartUpdates.push({
                    itemNo: itemNo,  // itemNo 값은 그대로 문자열로 저장
                    cartEa: cartEa
                });
            } else {
                console.error("itemNo가 누락되었거나 숫자가 아닙니다.");
            }
        });

        if (cartUpdates.length > 0) {
            console.log('cartUpdates:', cartUpdates);  // 서버로 보내는 데이터 확인

            $.ajax({
                url: '/api/updateCart',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(cartUpdates),
                success: function(result) {
                    printCart(result);  // 장바구니 갱신
                },
                error: function(xhr, status, error) {
                    console.error('Error:', error);
                    console.error('Response Text:', xhr.responseText);
                    alert("서버 오류: " + xhr.responseText);
                }
            });
        } else {
            console.error("업데이트할 장바구니 데이터가 없습니다.");
        }
    });

    // 선택삭제 버튼 클릭 시 동작
    $('#deleteBtn').click(function(e) {
        e.preventDefault();
        var selectedItems = [];

        // 선택된 체크박스를 가져옴
        $('input.choice:checked').each(function() {
            var itemNo = $(this).val().trim();  // .val()로 체크된 체크박스의 itemNo 값 가져옴
            console.log('itemNo:', itemNo);  // 디버깅용 출력

            // itemNo가 숫자인지 확인 후 숫자로 변환하여 selectedItems에 추가
            if (itemNo && !isNaN(Number(itemNo))) {
                selectedItems.push(Number(itemNo));  // 숫자로 변환 후 배열에 추가
            }
        });

        console.log("Selected items:", selectedItems);  // 선택된 항목들 출력

        if (selectedItems.length > 0) {
            // 서버로 보낼 데이터를 숨겨진 input에 저장
            var input = $('<input>', {
                type: 'hidden',
                name: 'itemNos', 
                value: selectedItems.join(',')  // itemNos 값을 콤마로 구분된 문자열로 전송
            });

            // 폼에 input 추가 후 제출
            $('#deleteForm').append(input);
            $('#deleteForm').submit();

            // 삭제 후 체크박스 상태 초기화 (모두 체크 해제)
            $('input.choice').prop('checked', false);

            // selectedItems 배열 초기화
            selectedItems = [];

        } else {
            // 선택된 항목이 없으면 경고
            alert('삭제할 항목을 선택해주세요.');
        }
    });
});
</script>

<body>
	<div id="app">
		<header th:replace="~{/fragment/header.html}"></header>
		<nav th:replace="~{/fragment/nav.html}"></nav>
		<section>
			<div th:text="${result}"></div>
			<table class='table'>
				<thead>
					<tr>
						<th><input type="checkbox" id="select-all"> 선택</th>
						<th>상품</th>
						<th>상품명</th>
						<th>금액</th>
						<th>구매수량</th>
						<th>총 금액</th>
					</tr>
				</thead>
				<tbody id="tbody">
					<!-- Thymeleaf에서 데이터 출력 -->
					<tr th:each="item : ${result}">
						<td>
							<!-- 체크박스에 itemNo 값을 value와 data-itemNo에 제대로 전달 -->
							<input type="checkbox" class="choice" th:value="${item.itemNo}" th:data-itemNo="${item.itemNo}" name="itemNos">
						</td>
						<td><img th:src="${item.itemImage}" style="height: 100px;"></td>
						<td th:text="${item.itemIrum}"></td>
						<td th:text="${item.itemPrice + '원'}"></td>
						<td><input type="number" class="cartEaInput" th:value="${item.cartEa}" th:data-itemNo="${item.itemNo}" min="1">
							<button class="btn btn-primary update">수량 변경</button></td>
						<td th:text="${item.cartTotalPrice + '원'}"></td>
					</tr>
				</tbody>
			</table>
			<button class="btn btn-success" id="order">선택주문</button>

			<form id="deleteForm" action="/cart/delete" method="POST">
				<!-- 선택삭제 버튼 -->
				<button type="button" id="deleteBtn" class="btn btn-danger">선택삭제</button>
			</form>
		</section>
		<footer th:replace="~{/fragment/footer.html}"></footer>
	</div>
</body>
</html>
